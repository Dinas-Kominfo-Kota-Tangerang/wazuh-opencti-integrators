#!/bin/bash
# OpenCTI Custom Wrapper Script
# Modified by nauliajati@tangerangkota.go.id for TangerangKota-CSIRT
# Wrapper for executing OpenCTI Python scripts in Wazuh environment

set -euo pipefail

readonly WPYTHON_BIN="framework/python/bin/python3"
readonly SCRIPT_PATH_NAME="$0"
readonly SCRIPT_NAME="$(basename "$SCRIPT_PATH_NAME")"
readonly LOG_TAG="custom-opencti"

# Logging function for consistent output
log_message() {
    local level="$1"
    local message="$2"
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$LOG_TAG] [$level] $message" >&2
}

log_info() {
    log_message "INFO" "$1"
}

log_error() {
    log_message "ERROR" "$1"
}

log_debug() {
    if [[ "${DEBUG:-0}" == "1" ]]; then
        log_message "DEBUG" "$1"
    fi
}

# Get directory path
DIR_NAME="$(dirname "$(readlink -f "$SCRIPT_PATH_NAME")")"
log_debug "Script directory: $DIR_NAME"

# Determine WAZUH_PATH and PYTHON_SCRIPT based on directory pattern
log_info "Determining Wazuh path and Python script location..."
case "$DIR_NAME" in
    */active-response/bin|*/wodles*)
        WAZUH_PATH="${WAZUH_PATH:-$(dirname "$(dirname "$DIR_NAME")")}"
        PYTHON_SCRIPT="${DIR_NAME}/${SCRIPT_NAME}.py"
        log_debug "Active response/wodles pattern detected"
        ;;
    */bin)
        WAZUH_PATH="${WAZUH_PATH:-$(dirname "$DIR_NAME")}"
        PYTHON_SCRIPT="${WAZUH_PATH}/framework/scripts/${SCRIPT_NAME}.py"
        log_debug "Bin directory pattern detected"
        ;;
    */integrations)
        WAZUH_PATH="${WAZUH_PATH:-$(dirname "$DIR_NAME")}"
        PYTHON_SCRIPT="${DIR_NAME}/${SCRIPT_NAME}.py"
        log_debug "Integrations directory pattern detected"
        ;;
    *)
        log_error "Script not in recognized directory structure: $DIR_NAME"
        log_error "Supported paths: */active-response/bin, */wodles*, */bin, */integrations"
        exit 1
        ;;
esac

log_debug "Wazuh path: $WAZUH_PATH"
log_debug "Python script: $PYTHON_SCRIPT"

# Validate paths exist
log_info "Validating required files..."

PYTHON_BINARY_PATH="${WAZUH_PATH}/${WPYTHON_BIN}"
if [[ ! -f "$PYTHON_BINARY_PATH" ]]; then
    log_error "Python binary not found at $PYTHON_BINARY_PATH"
    log_error "Please ensure Wazuh is properly installed and the framework directory exists"
    exit 1
fi

if [[ ! -x "$PYTHON_BINARY_PATH" ]]; then
    log_error "Python binary at $PYTHON_BINARY_PATH is not executable"
    exit 1
fi

if [[ ! -f "$PYTHON_SCRIPT" ]]; then
    log_error "Python script not found at $PYTHON_SCRIPT"
    log_error "Please ensure the corresponding .py file exists for this script"
    exit 1
fi

if [[ ! -r "$PYTHON_SCRIPT" ]]; then
    log_error "Python script at $PYTHON_SCRIPT is not readable"
    exit 1
fi

log_info "All validations passed. Executing Python script..."
log_debug "Command: $PYTHON_BINARY_PATH $PYTHON_SCRIPT $*"

# Trap to handle interruption gracefully
trap 'log_info "Script execution interrupted"; exit 130' INT TERM

# Execute with proper error handling and logging
if ! exec "$PYTHON_BINARY_PATH" "$PYTHON_SCRIPT" "$@"; then
    log_error "Failed to execute Python script"
    exit 1
fi
